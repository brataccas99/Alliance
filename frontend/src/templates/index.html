<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PNRR Futura Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>
</head>
<body>
    <div class="bg-accent"></div>
    <main class="page">
        <header class="hero">
            <div>
                <p class="eyebrow">Alliance Dashboard Bandi</p>
                <h1>Avvisi scuola, ordinati e ricercabili</h1>
                <p class="lede">Un cruscotto unico per sfogliare gli ultimi bandi, graduatorie e convocazioni. Cerca, ordina e apri il dettaglio con un clic.</p>
            </div>
            <div class="meta-card">
                <p class="label">Scuole monitorate</p>
                {% set schools_list = [] %}
                {% for ann in announcements %}
                    {% if ann.school_id not in schools_list %}
                        {% set _ = schools_list.append(ann.school_id) %}
                    {% endif %}
                {% endfor %}
                <p class="value">{{ schools_list|length }} scuole attive di Salerno con programmi PNRR Futura</p>
                <details class="schools-dropdown">
                    <summary class="schools-toggle">üìã Visualizza elenco completo</summary>
                    <ul class="schools-list">
                        {% set seen_schools = [] %}
                        {% for ann in announcements %}
                            {% if ann.school_id not in seen_schools %}
                                {% set _ = seen_schools.append(ann.school_id) %}
                                <li class="school-item">
                                    <span class="school-name">{{ ann.school_name }}</span>
                                    {% if ann.city %}
                                        <span class="school-city">{{ ann.city }}</span>
                                    {% endif %}
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </details>
            </div>
        </header>

                <!-- Statistics Cards -->
        <section class="stats-grid">
            <div class="stat-card clickable" data-quick-filter="all" title="Mostra tutti gli annunci">
                <div class="stat-content">
                    <p class="stat-label">Totale Annunci</p>
                    <p class="stat-value">{{ announcements|length }}</p>
                </div>
            </div>
            <div class="stat-card stat-highlight clickable" data-quick-filter="highlight" title="Filtra annunci evidenziati">
                <div class="stat-content">
                    <p class="stat-label">Evidenziati</p>
                    <p class="stat-value">{{ announcements|selectattr('highlight')|list|length }}</p>
                </div>
            </div>
            <div class="stat-card stat-success clickable" data-quick-filter="open" title="Filtra annunci aperti">
                <div class="stat-content">
                    <p class="stat-label">Aperti</p>
                    <p class="stat-value">{{ announcements|selectattr('status', 'equalto', 'Open')|list|length }}</p>
                </div>
            </div>
            <div class="stat-card clickable" data-quick-filter="pnrr" title="Filtra annunci PNRR">
                <div class="stat-content">
                    <p class="stat-label">PNRR</p>
                    {% set pnrr_count = announcements | selectattr('category') | select('lower') | select('contains', 'pnrr') | list | length %}
                    <p class="stat-value">{{ pnrr_count }}</p>
                </div>
            </div>
            <div class="stat-card clickable" data-quick-filter="pon" title="Filtra annunci PON">
                <div class="stat-content">
                    <p class="stat-label">PON</p>
                    {% set pon_count = announcements | selectattr('category') | select('lower') | select('contains', 'pon') | list | length %}
                    <p class="stat-value">{{ pon_count }}</p>
                </div>
            </div>
            <div class="stat-card clickable" data-quick-filter="recent" title="Ultimi 7 giorni">
                <div class="stat-content">
                    <p class="stat-label">Recenti</p>
                    {% set recent_count = announcements|selectattr('date')|select('ne', None)|list|length %}
                    <p class="stat-value">{{ recent_count }}</p>
                </div>
            </div>
        </section>
<!-- Saved Presets & Recently Viewed -->
        <section class="presets-section">
            <div class="presets-container">
                <div class="presets-header">
                    <h3>Filtri salvati</h3>
                    <button class="action-btn small" id="savePresetBtn" title="Salva filtri correnti">
                        üíæ Salva filtri
                    </button>
                </div>
                <div id="presetsList" class="presets-list">
                    <p class="empty-message">Nessun filtro salvato. Configura i filtri e clicca "Salva filtri".</p>
                </div>
            </div>
            <div class="recently-viewed-container">
                <div class="recently-viewed-header">
                    <h3>Visti di recente</h3>
                    <button class="action-btn small" id="clearRecentBtn" title="Cancella cronologia">
                        üóëÔ∏è Cancella
                    </button>
                </div>
                <div id="recentlyViewedList" class="recently-viewed-list">
                    <p class="empty-message">Nessun annuncio visualizzato di recente.</p>
                </div>
            </div>
        </section>

        <section class="controls">
            <div class="search">
                <label for="searchInput">Cerca annuncio</label>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input id="searchInput" type="search" placeholder="Titolo, parola chiave o tag" autocomplete="off">
                </div>
                <p class="hint">Il filtro √® immediato e funziona anche su tag e categoria. <kbd>Ctrl+K</kbd> per cercare</p>
            </div>
            <div class="filter-chips" aria-label="Filtri rapidi">
                <button class="chip active" data-filter="none">Tutti</button>
                <button class="chip" data-filter="highlight">Solo evidenziati</button>
                <button class="chip" data-filter="open">Stato: aperti</button>
                <button class="chip" data-filter="pnrr">Solo PNRR</button>
                <button class="chip" data-filter="pon">Solo PON</button>
            </div>
            <div class="select-filter">
                <label for="schoolFilter">Filtra per scuola</label>
                <select id="schoolFilter">
                    <option value="">Tutte le scuole</option>
                    {% set seen = [] %}
                    {% for ann in announcements %}
                        {% if ann.school_id not in seen %}
                            {% set _ = seen.append(ann.school_id) %}
                            <option value="{{ ann.school_id }}">{{ ann.school_name }}{% if ann.city %} ‚Äì {{ ann.city }}{% endif %}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="date-range-filter">
                <label for="dateFrom">Intervallo date</label>
                <div class="date-inputs">
                    <input type="date" id="dateFrom" placeholder="Da" title="Data inizio">
                    <span class="date-separator">‚Üí</span>
                    <input type="date" id="dateTo" placeholder="A" title="Data fine">
                    <button class="action-btn small" id="clearDatesBtn" title="Cancella filtro date">
                        ‚úï
                    </button>
                </div>
            </div>
            <div class="controls-actions">
                <button id="exportBtn" class="action-btn" title="Esporta risultati in CSV">
                    üì• Esporta CSV
                </button>
                <div class="result-meta">
                    <span id="resultsCount">{{ announcements|length }} record</span>
                </div>
            </div>
        </section>

        <!-- Quick Actions Bar -->
        <section class="quick-actions">
            <div class="quick-actions-left">
                <button class="action-btn small" id="selectAllBtn" title="Seleziona tutti visibili">
                    ‚òë Seleziona tutti
                </button>
                <button class="action-btn small" id="deselectAllBtn" title="Deseleziona tutti">
                    ‚òê Deseleziona
                </button>
                <span id="selectedCount" class="selected-count" style="display: none;">
                    <strong>0</strong> selezionati
                </span>
            </div>
            <div class="quick-actions-right">
                <button class="action-btn small" id="bulkReadBtn" disabled title="Marca selezionati come letti">
                    üëÅ Segna letti
                </button>
                <button class="action-btn small" id="bulkSkipBtn" disabled title="Marca selezionati come non rilevanti">
                    ‚äò Non rilevanti
                </button>
            </div>
        </section>

        <section class="table-card">
            <div class="table-head">
                <div>
                    <p class="label">Ultimi aggiornamenti</p>
                    <h2>Elenco annunci</h2>
                </div>
                <div class="table-actions">
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="table" title="Vista tabella">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M0 1h16v2H0V1zm0 4h16v2H0V5zm0 4h16v2H0V9zm0 4h16v2H0v-2z"/>
                            </svg>
                        </button>
                        <button class="view-btn" data-view="cards" title="Vista card">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M0 0h7v7H0V0zm9 0h7v7H9V0zM0 9h7v7H0V9zm9 0h7v7H9V9z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="legend">
                        <span class="pill pill-highlight">Evidenziato</span>
                        <span class="pill pill-open">Aperto</span>
                    </div>
                </div>
            </div>

            <table id="annTable">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAllCheckbox" title="Seleziona tutti" aria-label="Seleziona tutti">
                        </th>
                        <th data-sort="title">Annuncio</th>
                        <th data-sort="school">Scuola</th>
                        <th data-sort="city">Comune</th>
                        <th data-sort="category">Categoria</th>
                        <th data-sort="date" class="numeric">Data</th>
                        <th data-sort="status">Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ann in announcements %}
                    <tr
                        class="{% if ann.highlight %}row-highlight{% endif %}"
                        data-id="{{ ann.id }}"
                        data-date="{{ ann.date.isoformat() if ann.date else '' }}"
                        data-title="{{ ann.title }}"
                        data-school="{{ ann.school_name }}"
                        data-school-id="{{ ann.school_id }}"
                        data-city="{{ ann.city or '' }}"
                        data-category="{{ ann.category }}"
                        data-status="{{ ann.status }}"
                        data-highlight="{{ 'true' if ann.highlight else 'false' }}"
                        data-search="{{ ann.title }} {{ ann.summary }} {{ ann.school_name }} {{ ann.city or '' }} {{ ann.category }} {{ ', '.join(ann.tags) }}"
                    >
                        <td>
                            <input type="checkbox" class="row-checkbox" value="{{ ann.id }}" aria-label="Seleziona annuncio #{{ ann.id }}">
                        </td>
                        <td>
                            <div class="title-row">
                                <span class="badge">#{{ ann.id }}</span>
                                <div>
                                    <p class="title">{{ ann.title }}</p>
                                    <p class="subtitle">{{ ann.summary }}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="pill">{{ ann.school_name }}</span>
                        </td>
                        <td>
                            <span class="pill">{{ ann.city or '‚Äî' }}</span>
                        </td>
                        <td>
                            <span class="pill">{{ ann.category }}</span>
                        </td>
                        <td class="numeric">
                            {% if ann.date and ann.date.year > 1 %}
                                {{ ann.date.strftime('%d %b %Y') }}
                            {% else %}
                                s.n.
                            {% endif %}
                        </td>
                        <td>
                            <span class="pill {{ 'pill-open' if ann.status == 'Open' else '' }}">{{ ann.status }}</span>
                        </td>
                        <td>
                            <div class="actions-stack">
                                <a class="ghost detail-link" href="{{ url_for('announcement.announcement_detail', ann_id=ann.id) }}">Apri dettagli</a>
                                <div class="state-control">
                                    <label class="sr-only" for="state-{{ ann.id }}">Stato personale</label>
                                    <select class="state-select" id="state-{{ ann.id }}">
                                        <option value="none">Stato personale</option>
                                        <option value="read">Letto</option>
                                        <option value="applied">Candidatura inviata</option>
                                        <option value="skip">Non rilevante</option>
                                    </select>
                                    <span class="pill state-pill" data-state-label></span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if announcements|length == 0 %}
                <div class="empty">Nessun annuncio trovato.</div>
            {% endif %}

            <!-- Card View (initially hidden) -->
            <div id="cardView" class="cards-grid" style="display: none;">
                {% for ann in announcements %}
                <div class="announcement-card {% if ann.highlight %}card-highlight{% endif %}"
                     data-date="{{ ann.date.isoformat() if ann.date else '' }}"
                     data-title="{{ ann.title }}"
                     data-school="{{ ann.school_name }}"
                     data-school-id="{{ ann.school_id }}"
                     data-city="{{ ann.city or '' }}"
                     data-category="{{ ann.category }}"
                     data-status="{{ ann.status }}"
                     data-highlight="{{ 'true' if ann.highlight else 'false' }}"
                     data-search="{{ ann.title }} {{ ann.summary }} {{ ann.school_name }} {{ ann.city or '' }} {{ ann.category }} {{ ', '.join(ann.tags) }}"
                >
                    <div class="card-header">
                        <div class="card-meta">
                            <span class="badge">#{{ ann.id }}</span>
                            <span class="pill {{ 'pill-open' if ann.status == 'Open' else '' }}">{{ ann.status }}</span>
                            {% if ann.highlight %}<span class="pill pill-highlight">‚≠ê Evidenziato</span>{% endif %}
                        </div>
                        <span class="card-date">
                            {% if ann.date and ann.date.year > 1 %}
                                {{ ann.date.strftime('%d %b %Y') }}
                            {% else %}
                                s.n.
                            {% endif %}
                        </span>
                    </div>
                    <h3 class="card-title">{{ ann.title }}</h3>
                    <p class="card-summary">{{ ann.summary }}</p>
                    <div class="card-footer">
                        <div class="card-tags">
                            <span class="pill">{{ ann.school_name }}</span>
                            {% if ann.city %}<span class="pill">{{ ann.city }}</span>{% endif %}
                            <span class="pill">{{ ann.category }}</span>
                        </div>
                        <a class="card-link" href="{{ url_for('announcement.announcement_detail', ann_id=ann.id) }}">
                            Dettagli ‚Üí
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>
</body>
</html>
